<!doctype html public "-//W30//DTD W3 HTML 2.0//EN">

<HTML>

<!-- This file was generated using SDF 2.001 by
     Ian Clatworthy (ianc@mincom.com). SDF is freely
     available from http://www.mincom.com/mtr/sdf. -->

<HEAD>
<TITLE>Life With qmail-ldap</TITLE>
</HEAD>
<BODY>

<DIV CLASS="header">
<DIV CLASS="navigate">
</DIV>
</DIV>
<DIV CLASS="title">
<H1 CLASS="doc-title">Life With qmail-ldap</H1>
<ADDRESS CLASS="doc-author">Henning Brauer &lt;lists-lwql@bsws.de&gt;</ADDRESS>
<ADDRESS CLASS="doc-modified">2 April 2004</ADDRESS>
<BR CLEAR="All">
</DIV>
<DIV CLASS="contents">
<HR>
<H2>Table of Contents</H2>
<UL>
<A HREF="#Availability">1. Availability</A>
<BR>
<A HREF="#Introduction">2. Introduction</A>
<BR>
<A HREF="#Other resources">3. Other resources</A><UL>
<A HREF="#Online Documents">3.1. Online Documents</A>
<BR>
<A HREF="#Mailing-List">3.2. Mailing-List</A></UL>
<BR>
<A HREF="#short Intro to LDAP">4. short Intro to LDAP</A><UL>
<A HREF="#Basics">4.1. Basics</A>
<BR>
<A HREF="#Schema for OpenLDAP 1.2.x">4.2. Schema for OpenLDAP 1.2.x</A>
<BR>
<A HREF="#Schema for OpenLDAP 2.x">4.3. Schema for OpenLDAP 2.x</A>
<BR>
<A HREF="#Configuration">4.4. Configuration</A>
<BR>
<A HREF="#Filling the Directory">4.5. Filling the Directory</A></UL>
<BR>
<A HREF="#The Big Picture">5. The Big Picture</A><UL>
<A HREF="#Components of qmail-ldap and how they fit together">5.1. Components of qmail-ldap and how they fit together</A></UL>
<BR>
<A HREF="#Additoinal Software">6. Additoinal Software</A><UL>
<A HREF="#daemontools">6.1. daemontools</A>
<BR>
<A HREF="#ucspi-tcp">6.2. ucspi-tcp</A></UL>
<BR>
<A HREF="#Installation">7. Installation</A>
<BR>
<A HREF="#Example Configurations">8. Example Configurations</A><UL>
<A HREF="#Basic Setup">8.1. Basic Setup</A>
<BR>
<A HREF="#webmail">8.2. webmail</A>
<BR>
<A HREF="#Cluster">8.3. Cluster</A>
<BR>
<A HREF="#domain aliassing">8.4. domain aliassing</A>
<BR>
<A HREF="#dash extension adressing explained">8.5. dash extension adressing explained</A></UL>
<BR>
<A HREF="#Comparison with stock qmail, migration issues">9. Comparison with stock qmail, migration issues</A>
<BR>
<A HREF="#Testing configs, diagnosing problems">10. Testing configs, diagnosing problems</A>
<BR>
<A HREF="#Performance">11. Performance</A>
<BR>
<A HREF="#The qmail-ldap-control patch">12. The qmail-ldap-control patch</A><UL>
<A HREF="#Basics">12.1. Basics</A>
<BR>
<A HREF="#Installation: qmail-ldap-control">12.2. Installation: qmail-ldap-control</A>
<BR>
<A HREF="#Example Configurations - move the control files to ldap">12.3. Example Configurations - move the control files to ldap</A></UL>
<BR>
<A HREF="#Additional Patches">13. Additional Patches</A><UL>
<A HREF="#SMTP after POP">13.1. SMTP after POP</A>
<BR>
<A HREF="#SMTP AUTH">13.2. SMTP AUTH</A>
<BR>
<A HREF="#The Dash-Trick">13.3. The Dash-Trick</A>
<BR>
<A HREF="#MXPS and QMTP for qmail-remote">13.4. MXPS and QMTP for qmail-remote</A>
<BR>
<A HREF="#RBL Tagging">13.5. RBL Tagging</A></UL>
<BR>
<A HREF="#Installing packages">A. Installing packages</A><UL>
<A HREF="#Manual source install">A.1. Manual source install</A></UL>
<BR>
<A HREF="#typical problems">B. typical problems</A><UL>
<A HREF="#shared library problems">B.1. shared library problems</A></UL>
<BR>
<A HREF="#Operating System specifics">C. Operating System specifics</A>
<BR>
<A HREF="#qmail-ldap and ezmlm">D. qmail-ldap and ezmlm</A>
<BR>
<A HREF="#useful Links">E. useful Links</A>
<BR>
<A HREF="#Acknowlegements">F. Acknowlegements</A></UL>
</DIV>
<DIV CLASS="main">
<HR>
<H1><A NAME="Availability">1. Availability</A></H1>
<P>The newest version of this document is always at <A HREF="http://www.lifewithqmail.org/ldap/">http://www.lifewithqmail.org/ldap/</A> in HTML format.</P>
<HR>
<H1><A NAME="Introduction">2. Introduction</A></H1>
<P>This document will probably never be as comprehensively helpful as its inspiration, <A HREF="http://www.lifewithqmail.org/">Life With Qmail</A> by Dave Sill, and it won't explain the basics of qmail and ldap. It will explain the basic setup of qmail-ldap, but you must understand qmail and ldap to get qmail-ldap working.</P>
<P>qmail-ldap is a patch to qmail 1.03 to retrieve all user data from a ldap-directory rather then from files on the disk. This allows easier administration, especially in distributed environments. There is also clustering support builtin making qmail-ldap very well suited for big mail installations at ISPs.</P>
<P>This document will attempt to give the Big Picture, which is most of what you need to get going; describe the components of qmail-ldap and how they fit together; provide illustrations of typical installations; and hopefully in the process field some of the more Frequently Asked Questions; but it is not intended to be a replacement for any of the existing qmail and ldap documentation; this is an introductory paper, to be read in sequential order, not a reference.</P>
<P>This fantastic piece of software was developed by Andre Oppermann and Claudio Jeker.</P>
<HR>
<H1><A NAME="Other resources">3. Other resources</A></H1>
<H2><A NAME="Online Documents">3.1. Online Documents</A></H2>
<P><A HREF="http://www.qmail-ldap.org">Official qmail-ldap pages</A></P>
<P><A HREF="http://www.lifewithqmail.org">Life With Qmail</A> by Dave Sill</P>
<P><A HREF="http://www.lifewithqmail.org/ldap/patches/">additional patches for qmail-ldap</A></P>
<P>Adfinis released <A HREF="http://phpqladmin.bayour.com">phpQLAdmin</A>, a web based administration tool for qmail-ldap, which is now maintained by Turbo Fredriksson.</P>
<P>A set of command line admin tools is available: <A HREF="http://www.enderunix.org/qldapadmin">http://www.enderunix.org/qldapadmin</A></P>
<H2><A NAME="Mailing-List">3.2. Mailing-List</A></H2>
<P>There's also a Mailing list, qmail-ldap@qmail-ldap.org. Subscribe by sending an empty mail to qmail-ldap-subscribe@qmail-ldap.org, unsubscribing works similar by sending an empty mail to qmail-ldap-unsubscribe@qmail-ldap.org.</P>
<P>If you post to the list, please make sure that you have read all available documentation, that you understand LDAP and qmail and to include all necessary information. This is at least your ~/control/* stuff, complete error description, and the logs. If this is really much, consider uploading the infos on a webserver and post the url.</P>
<P>There is a searchable <A HREF="http://www.suares.com/qmail-ldap/archive/">archive</A>. Please use it before asking the list. Another one is on <A HREF="http://marc.theaimsgroup.com/?l=qmail-ldap">http://marc.theaimsgroup.com/?l=qmail-ldap</A></P>
<HR>
<H1><A NAME="short Intro to LDAP">4. short Intro to LDAP</A></H1>
<H2><A NAME="Basics">4.1. Basics</A></H2>
<P>Lightweight Directory Access Protocol, or LDAP, is a very useful tool in administration of large networks and organizations. It is a database that is highly optimized for read operations, up to ten times faster than SQL database systems. One of the best features of LDAP is the ability to store user accounts. A single account entry can be used for logging in to unix workstations, imap servers, access controlled web pages, and email account storage.</P>
<P>With the qmailUser schema and user accounts loaded into an LDAP server, Qmail-LDAP can be configured so that all mail servers in an organization can share this same account data. Qmail-LDAP supports message routing to the mailhost specified in each users account entry, even when all internal email accounts use business card style addresses such as user@company.com. There is no need to use internal addresses like user@mailhost1.company.com and convert them to user@company.com when mail leaves the intranet.</P>
<P>Using LDAP to store Qmail-LDAP email accounts requires either building an LDAP directory, or modifying your existing directory. Since Qmail-LDAP requires the administrator to have a prior understanding of LDAP, this section of the HOWTO does not deal with basic LDAP or unix topics. For those who are completely unfamiliar with LDAP directory construction and administration, there are excellent books available and there are searchable mailing list archives at http://www.openldap.org.</P>
<P>1. The first part of setting up the directory server to work with Qmail-LDAP is to add the schema. This is not required if you have disabled schema checking, however running an LDAP server with schema checking disabled is highly discouraged. How the schema is loaded depends on the server you are using.</P>
<H2><A NAME="Schema for OpenLDAP 1.2.x">4.2. Schema for OpenLDAP 1.2.x</A></H2>
<P>Edit slapd.oc.conf and add the following schema.</P>
<PRE>
  objectclass qmailUser
        requires
                objectclass,
                mail,
                uid
        allows
                mailMessageStore,
                homeDirectory,
                userPassword,
                mailAlternateAddress,
                qmailUID,
                qmailGID,
                mailQuota,
                mailHost,
                mailForwardingAddress,
                deliveryProgramPath,
                qmailDotMode,
                deliveryMode,
                mailReplyText,
                accountStatus
</PRE>
<P>Restart slapd for changes to take effect.</P>
<H2><A NAME="Schema for OpenLDAP 2.x">4.3. Schema for OpenLDAP 2.x</A></H2>
<P>Edit slapd.conf and add the following lines, of course to match your file locations:</P>
<PRE>
  include /etc/ldap/schema/inetOrgPerson.schema
  include /etc/ldap/schema/nis.schema      (required by inetOrgPerson.schema)
  include /etc/ldap/schema/qmail.schema    (found from the qmail-ldap patch,
                                            copy it to your schema directory)
</PRE>
<P>Restart slapd for changes to take effect.</P>
<H2><A NAME="Configuration">4.4. Configuration</A></H2>
<P>Now that you have the schema loaded, a little system configuration is needed. I am going to discuss virtual user accounts, meaning that there are no home directories or /etc/passwd accounts for users on the mail server. After all, this is a mail server and not a user playground.</P>
<P>This involves setting a few control files:</P>
<PRE>
     - edit /etc/passwd and add:  vmail:*:11184:2110::/var/qmail/maildirs/:/bin/true

     - edit /etc/group and add:   vmail::2110

     - mkdir /var/qmail/maildirs

     - chown -R vmail:vmail /var/qmail/maildirs

     - cd /var/qmail/control

     - Create the following control files with specified contents in /var/qmail/control:

          defaultdelivery:
          ./Maildir/

          ldapmessagestore:
          /var/qmail/maildirs

          ldapgid:
          2110

          ldapuid:
          11184
</PRE>
<P>Substitute UIDs/GIDs and pathes if needed.</P>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>If you are using Courier-Imap, this same vmail user can be used for accessing the maildirs.
<HR WIDTH="80%" ALIGN="Left"></P>
<H2><A NAME="Filling the Directory">4.5. Filling the Directory</A></H2>
<P>At this point, you need to create the directory hierarchy and accounts. I will demonstrate how to do this from a newly installed directory server that has had nothing previously entered.</P>
<P>a. Use your text editor of choice to create an ldif. Modify according to your particular setup. The first block in the ldif must match the directory base that is defined in your slapd.conf file:</P>
<PRE>
  suffix          &quot;ou=company, c=CC&quot;
</PRE>
<P>Or if you already have a working directory, then you can just exclude the first block.</P>
<PRE>
  dn: o=company, c=CC
  objectclass: top
  objectclass: organisation
  o: company

  dn: ou=accounts, o=company, c=CC
  objectclass: top
  objectclass: organizationalUnit
  ou: accounts

  dn: uid=elvis, ou=accounts, o=company, c=CC
  cn: Elvis Presley
  sn: Presley
  objectClass: top
  objectClass: person
  objectClass: inetOrgPerson
  objectClass: qmailUser
  mail: elvis@graceland.com
  mailAlternateAddress: elvis.presley@graceland.com
  mailAlternateAddress: the-king@graceland.com
  mailAlternateAddress: theking@nirvana.org
  mailHost: mailhost1.graceland.com
  mailMessageStore: /var/qmail/maildirs/elvis
  uid: elvis
  userPassword: {MD5}X03MO1qnZdYdgyfeuILPmQ==
</PRE>
<P>b. After you have created the file, load it into your directory with the ldapadd utility.</P>
<PRE>
  ldapadd -acrv -h ldap.company.com -D &quot;cn=manager,dc=company,dc=com&quot; -w managers_password -f my.ldif
</PRE>
<P>See the ldapadd(1) manual page for more information.</P>
<HR>
<H1><A NAME="The Big Picture">5. The Big Picture</A></H1>
<P><IMG SRC="tbpql.png"></P>
<P>See also the <A HREF="http://www.qmail-ldap.org/qmail/the-big-qmail-picture-103-a4.pdf">qmail</A> and <A HREF="http://www.qmail-ldap.org/qmail/the-big-qmail-ldap-picture-20031112.pdf">qmail-ldap</A> big pictures from the <A HREF="http://www.qmail-ldap.org">qmail-ldap</A> homepage.</P>
<H2><A NAME="Components of qmail-ldap and how they fit together">5.1. Components of qmail-ldap and how they fit together</A></H2>
<H3><A NAME="qmail-queue">5.1.1. qmail-queue</A></H3>
<P>qmail-queue takes messages and places them in the queue. It always adds a &quot;received&quot;-line and does no further message inspection.</P>
<H3><A NAME="qmail-send">5.1.2. qmail-send</A></H3>
<P>qmail-send handles messages placed in the outgoing queue by qmail-queue and uses qmail-lspawn for local deliveries and qmail-rspawn for remote deliveries. qmail-send will reschedule all messages in the queue for immediate delivery.</P>
<H3><A NAME="qmail-todo">5.1.3. qmail-todo</A></H3>
<P>qmail-todo does the mail preprocessing to reduce the work load in qmail-send. With qmail-todo the overall performance on high throughput mail servers is far better because of the so called &quot;silly qmail syndrom&quot; caused by a over loaded qmail-send process.</P>
<H3><A NAME="qmail-lspawn">5.1.4. qmail-lspawn</A></H3>
<P>qmail-lspawn looks up the user for a mail to be delivered locally and invokes qmail-local to perform it.</P>
<H3><A NAME="qmail-local">5.1.5. qmail-local</A></H3>
<P>qmail-local performs the delivery. It also handles the .qmail-files.</P>
<H3><A NAME="qmail-rspawn">5.1.6. qmail-rspawn</A></H3>
<P>qmail-rspawn invokes qmail-remote for remote deliveries.</P>
<H3><A NAME="qmail-remote">5.1.7. qmail-remote</A></H3>
<P>qmail-remote sends a mail to a remote host via SMTP.</P>
<H3><A NAME="qmail-inject">5.1.8. qmail-inject</A></H3>
<P>qmail-inject reads a message from its stadard input, adds headers and invokes qmail-queue to handle the delivery.</P>
<H3><A NAME="qmail-smtpd">5.1.9. qmail-smtpd</A></H3>
<P>qmail-smtpd normally listens on port 25/tcp and receives messages from remote hosts via SMTP.</P>
<H3><A NAME="qmail-qmqpd">5.1.10. qmail-qmqpd</A></H3>
<P>qmail-qmqpd receives messages from remote hosts via QMQP, the Quick Message Queuing Protocol. It will relay _every_ message, so you must make sure only preauthorized hosts can connect. QMQP is used for in-cluster deliveries, if you want to use qmail-ldap's clusteriung you must set up qmail-qmqpd.</P>
<H3><A NAME="qmail-popup">5.1.11. qmail-popup</A></H3>
<P>qmail-popup reads username and password for POP3 from the network and invokes a subprogram (usually auth_pop) for authentification.</P>
<H3><A NAME="qmail-pop3d">5.1.12. qmail-pop3d</A></H3>
<P>qmail-pop3d is invoked from qmail-popup and handles the POP3-session.</P>
<H3><A NAME="auth_pop">5.1.13. auth_pop</A></H3>
<P>Is normally invoked from qmail-popup to authentificate the user. It is also responsible for pop3-session forwarding inside a qmail-ldap cluster.</P>
<H3><A NAME="auth_imap">5.1.14. auth_imap</A></H3>
<P>As auth_pop, but for IMAP. Handles also session forwarding.</P>
<H3><A NAME="qmail-ldaplookup">5.1.15. qmail-ldaplookup</A></H3>
<P>Is a tool to check if your ldap setup is correct. Use qmail-ldaplookup -u [uid] or qmail-ldaplookup -m [mail address].</P>
<HR>
<H1><A NAME="Additoinal Software">6. Additoinal Software</A></H1>
<H2><A NAME="daemontools">6.1. daemontools</A></H2>
<P>Daemontools is a companion package, prerequisite to qmail-ldap. It provides some helper programs which assist in launching and managing daemons.</P>
<P>qmail-ldap is delivered with service run scripts in /var/qmail/boot that can often be used without any modification.</P>
<PRE>
    svscan does a vaguely similar job to the System V init: it
        monitors jobs and ensures that they keep running. It's
        normally started with the directory /service, and each
        subdirectory of that directory defines a service; they are
        normally symlinks.
    svc provides an interactive user interface for controlling
        svscan; it takes an option like &quot;-u&quot; for up, &quot;-d&quot; for down,
        or &quot;-t&quot; to take down and up again, followed by a service
        name in the form of a path to a controlled directory.
        Commonest case might be
                svc -t /service/qmail-send
        to restart qmail-send.
    svstat tells the status of service. Just pass the path to a
        controlled directory. For example
                svstat /service/qmail-send
    supervise is run by svscan to watch over a specific daemon, and
        restart it if it dies.
    multilog reads log data from stdin, optionally filters it, and
        deposits the results into one or more logfiles, handling
        rotation automatically.
</PRE>
<P>More information can be found on the <A HREF="http://cr.yp.to/daemontools.html">daemontools</A> home page.</P>
<H2><A NAME="ucspi-tcp">6.2. ucspi-tcp</A></H2>
<P><A HREF="http://cr.yp.to/proto/ucspi.txt">UCSPI</A> is the UNIX Client-Server Program Interface. It defines a command-line structure and environment variable specifications for inter-process communications helper programs; these make it easier to write clients and servers.</P>
<P><A HREF="http://cr.yp.to/proto/ucspi-tcp.txt">UCSPI-TCP</A> is the specific variety of UCSPI for TCP applications; it specifies more details about specific environment variables and suchlike details.</P>
<P><A HREF="http://cr.yp.to/ucspi-tcp.html">ucspi-tcp</A> is <A HREF="mailto:djb@cr.yp.to">djb</A>'s package implementing UCSPI-TCP.</P>
<PRE>
    tcpserver
        like inetd, only for a single service. An invocation
        of tcpserver will listen for connections on a port, when one
        arrives it will start a client program with args as
        specified on the tcpserver cmdline, and with envars as
        specified by UCSPI-TCP. tcpserver implements access-control
        rules.
    tcprules
        compiles the access control rules for tcpserver into a cdb
        database
    tcpclient
        A client helper program; does the setup for writing network
        clients for TCP protocols, following the UCSPI-TCP
        specification.
</PRE>
<P>There is a SSL/TLS extension patch available for ucspi-tcp that is needed to support secure pop3 and imap connections. The patch can be found on the <A HREF="http://www.qmail-ldap.org">qmail-ldap</A> home page.</P>
<HR>
<H1><A NAME="Installation">7. Installation</A></H1>
<P>Install ucspi-tcp and daemontools according to Appendix 1.</P>
<P>Get qmail-1.03.tar.gz from <A HREF="http://cr.yp.to/software/qmail-1.03.tar.gz">cr.yp.to</A>. Get the patch from <A HREF="http://www.qmail-ldap.org/">www.qmail-ldap.org</A>. Unpack both, chdir to qmail-1-03. Patch the source tree:</P>
<PRE>
  patch -p1 &lt; /path/to/qmail-ldap-1.03-xxxxxxxx.patch
</PRE>
<P>Edit the Makefile to reflect your setup. You can change the following values:</P>
<PRE>
  ALTQUEUE
    Enable the qmail-queue patch that makes it possible to select a different
    qmail-queue program on runtime.
  BIGBROTHER
    For ISP that need to implement some surveillance method because of some
    beloved authoroties (like here in switzerland), you can enable a per
    address queue extra feature. See also the ~control/bigbrother file.
  BIGTODO
    Enables the big todo patch. Normaly not needed.
  BIND_8_COMPAT
    If the compile fails building dns.c because of undeclared defines this
    may help. This is necessary on MacOS X 10.3.
  CLEARTEXTPASSWORD (really bad idea)
    Allows cleartextpasswords in ldap. Normally, passwords without prefix
    are treated as crypt passwords.
  DASH-EXT
    Turns the dash extension mechanism on.
  DATA_COMPRESS
    Use smtp on the fly DATA compression if available. Needs the ZLIB options.
  EXTERNAL_TODO
    Run with the external high-performance todo processing. This avoids the
    silly qmail syndrome with high mail injection rates.
  IGNOREVERISIGN
    Disallow dns wildchar matches on gtlds, thanks verisign.
  QLDAP_CLUSTER
    Compiles the clustering code in. Note: this doesn't mean clustering is
    on, it just means you _can_ turn it on.
  QMQP_COMPRESS
    Use the QMQP on the fly compression for cluster forwards.
  QUOTATRASH
    Include the Trash in the quota calculation (normaly it is not).
  SMTPEXECCHECK
    Enable SMTP DOS/Windows executable and bad MIME attachement detection.

  LDAPLIBS
    Libraries you need for ldap, normally -lldap and -llber. On some systems
    -lresolv is needed, too. If you have problems compiling, double check this.
    For OpenLDAP, you typically have
          LDAPLIBS=-lldap -llber.
        For Netscape you'll need something like
      LDAPLIBS=-L/usr/local/ldap/lib -lldap50 -llber50 -lpthread
      LDAPINCLUDES=-I/usr/local/ldap/include
    Don't forget to adjust the pathes.
  LDAPINCLUDES
    Path to ldap-includefiles, at least ldap.h and lber.h. If you have
    problems compiling, double-check this.

  ZLIB
    ZLIB is needed for for -DDATA_COMPRESS and -DQMQP_COMPRESS.
    If the zlib is installed in a non standard localtion ZINCLUDES should also
    be set.

  TLS
    Enables SMTP encryption via SSL. You'll need OpenSSL.
    Use -DTLS_REMOTE to enable tls support in qmail-remote
    Use -DTLS_SMTPD to enable tls support in qmail-smtpd
  TLSINCLUDES
    Path to OpenSSL include files. If you have TLS enabled and compilation
    problems, double check this.
    Typical: /usr/local/include or /usr/local/openssl/include.
  TLSLIBS
    Path to OpenSSL libs.
    Typical: /usr/local/lib or /usr/local/openssl/lib.
  OPENSSLBIN
    Path to OpenSSL binary, only used for make cert.
    Typical: /usr/sbin/openssl or /usr/local/openssl/bin/openssl.

  MAKE_NETSCAPE_WORK
    Turns on a bugfix for Netscape's download progress bar and qmail-pop3d.
  AUTOMAILDIRMAKE
    Turns the auto-MAILdirmake-patch on. No external script needed.
  AUTOHOMEDIRMAKE
    Compiles the auto-HOMEdirmake-patch in. You need to specify an external
    script in ~/control/dirmaker which creates the homedir. It gets the dir
    as first (and only) parameter. Note: this script runs under the affected
    user's permissions, so, if the homedir for a system user &quot;joe&quot; should be
    created in /home, joe must have write permissions in /home.

  SHADOWLIBS=-lcrypt &amp; SHADOWOPTS=-DPW_SHADOW
    is needed on most systems except OpenBSD. On some systems (Linux, Solaris)
    -DSHADOWLIBS=-lcrypt -lshadow is needed if you use system users. Also
    SHADOWOPTS is needed to support shadowlibs on some systems (Solaris).

  DEBUG
    compiles some debugging code in. See QLDAPINSTALL for more info.
</PRE>
<P>You can change the ldap attribute names in qmail-ldap.h, this is self explaining. Also check the conf-* files. On some systems, at least OpenBSD up to 3.4, you have to modify either conf-spawn or conf-cc:</P>
<PRE>
  echo 125 &gt; /path/to/conf-spawn
    - OR -
  echo &quot;cc -O2 -DFD_SETSIZE=4096&quot; &gt; /path/to/conf-cc
</PRE>
<P>After editing Makefile and checking conf-*, you must add the users for qmail. You MUST add them BEFORE compiling, and you can't change their uids afterwards. Please see INSTALL.ids for example scripts.</P>
<P>Now it's time to compile:</P>
<PRE>
    make setup check
</PRE>
<P>If you are using TLS (SSL encryption), you must create an certificate. Please refer to OpenSSL's documentation for explanations about certificates.</P>
<PRE>
    make cert
   - or -
    make cert-req
</PRE>
<HR>
<H1><A NAME="Example Configurations">8. Example Configurations</A></H1>
<H2><A NAME="Basic Setup">8.1. Basic Setup</A></H2>
<H3><A NAME="setting up the control files">8.1.1. setting up the control files</A></H3>
<P>All these files are in /var/qmail/control.</P>
<H4><A NAME="me">8.1.1.1. me</A></H4>
<P>Contains your Mailservers fully qualified domain name (FQDN).</P>
<PRE>
    echo &quot;mail.yourdomain.com&quot; &gt; me
</PRE>
<H4><A NAME="rcpthosts">8.1.1.2. rcpthosts</A></H4>
<P>Contains all domains qmail-ldap accepts mail for, one per line.</P>
<PRE>
    echo &quot;yourdomain.com&quot; &gt; rcpthosts
    echo &quot;mail.yourdomain.com&quot; &gt;&gt; rcpthosts
    echo &quot;otherdomain.com&quot; &gt;&gt; rcpthosts
</PRE>
<H4><A NAME="locals">8.1.1.3. locals</A></H4>
<P>Contains all domains for which qmail-ldap delivers mail locally. Same format as rcpthosts.</P>
<H4><A NAME="ldapbasedn">8.1.1.4. ldapbasedn</A></H4>
<P>The BaseDN for ldap searches. See OpenLDAP's documentation for more information about BaseDN. Required.</P>
<PRE>
    echo &quot;o=yourcorp, c=de&quot; &gt; ldapbasedn
</PRE>
<H4><A NAME="ldapserver">8.1.1.5. ldapserver</A></H4>
<P>Your ldap server's hostname. If you want more than one ldap-server for redundancy, list one hostname per line. You can append a port number if your LDAP server does not run on its default port 389.</P>
<PRE>
  ldap.example.com:389
  ldap2.example.com:389
</PRE>
<P>Required.</P>
<H4><A NAME="ldaplogin">8.1.1.6. ldaplogin</A></H4>
<P>If you need to authentificate against your ldap server to retrieve the user information, this is the username to do so. Note: this is a ldap dn, not a unix username.</P>
<P>Default: NULL (do not authentificate)</P>
<PRE>
   echo &quot;cn=root, o=yourcorp, c=de&quot; &gt; ldaplogin
</PRE>
<H4><A NAME="ldappassword">8.1.1.7. ldappassword</A></H4>
<P>The password for the user defined in ldaplogin if needed. Cleartext, so this file should be owned by root and mode 600.</P>
<P>Default: NULL</P>
<H4><A NAME="ldaptimeout (new in 20010101)">8.1.1.8. ldaptimeout (new in 20010101)</A></H4>
<P>After this time (in seconds) an ldaplookup is treated as &quot;failed&quot;. Helpfull if your ldap server hangs. Default: 30 sec.</P>
<H4><A NAME="ldaplocaldelivery">8.1.1.9. ldaplocaldelivery</A></H4>
<P>To lookup the local passwd file if (and only if) the ldap lookup didn't find a matching entry. Affects qmail-lspawn and auth_pop. Boolean, either 0 (off) or 1 (on).</P>
<P>Default: 1</P>
<PRE>
    echo 0 &gt; ldaplocaldelivery
</PRE>
<H4><A NAME="ldaprebind">8.1.1.10. ldaprebind</A></H4>
<P>If enabled (1), qmail-ldap does not try to retrieve the userpassword-attribute from ldap, instead, it tries to bind to the ldap server using the looked up DN and the supplied password (affects auth_pop and auth_imap). This allows your ACL to be more restrictive, nobody except the user himself needs the right to retrieve his password from the ldap directory.</P>
<P>Default: 0 (off)</P>
<H4><A NAME="ldapobjectclass (new in 20010101)">8.1.1.11. ldapobjectclass (new in 20010101)</A></H4>
<P>If given, ldap lookups are limited to entries having this objectclass. This is useful if you use your ldap directory for other purposes, too, and only users having a special objectclass (qmailuser for example) should have mail accounts.</P>
<PRE>
  echo &quot;qmailuser&quot; &gt; ldapobjectclass
</PRE>
<P>ATTENTION: broken in 20010101, has no effect</P>
<H4><A NAME="ldapuid">8.1.1.12. ldapuid</A></H4>
<P>The system user id your virtual users are mapped to. You can add as much users as you want to you ldap directory without having system accounts for them, they are all mapped to a single system user id - this one is defined here.</P>
<H4><A NAME="ldapgid">8.1.1.13. ldapgid</A></H4>
<P>The system group id all your virtual users are mapped to.</P>
<H4><A NAME="ldapdefaultdotmode">8.1.1.14. ldapdefaultdotmode</A></H4>
<P>The default interpretation of .qmail files Possible values:</P>
<PRE>
    both (ldap attribute &quot;deliveryProgramPath&quot; and .qmail files are used)
    dotonly (only .qmail files are used)
    ldaponly (ldap attribute &quot;deliveryProgramPath&quot; and .qmail files are ignored)
    ldapwithprog (attribute &quot;deliveryProgramPath is used if existant, .qail
                 files are ignored))
</PRE>
<P>Default: ldaponly Note: does of course NOT work for non-ldap deliveries (user information retrieved from /etc/passwd if ldaplocaldelivery is enabled).</P>
<H4><A NAME="ldapmessagestore">8.1.1.15. ldapmessagestore</A></H4>
<P>The default prefix for paths in mailmessagestore without leading / If you set this to /maildisk/ for example, the ldap attributes</P>
<PRE>
    mailmessagestore: joe/
    mailmessagestore: /maildisk/joe/
</PRE>
<P>are equivalent.</P>
<P>Default: NULL</P>
<H4><A NAME="defaultquotasize">8.1.1.16. defaultquotasize</A></H4>
<P>The default maximum amount of disk space the user can use until all further messages get bounced back to the sender. Size is a byte count. Overridden by user's attribute mailquotasize if existant. Default: NULL (no size limit)</P>
<PRE>
    echo &quot;1000000&quot; &gt; defaultquotasize
</PRE>
<P>This means: 1000000 bytes (1MB) size.</P>
<P>Don't forget to set quotawarning, otherwise no quota warning messages are issued.</P>
<H4><A NAME="defaultquotacount">8.1.1.17. defaultquotacount</A></H4>
<P>The default maximum amount of messages the user can have until all further messages get bounced back to the sender. Count is a file count. Overridden by user's attribute mailquotacount if existant. Default: NULL (no count limit)</P>
<PRE>
    echo &quot;1000&quot; &gt; defaultquotacount
</PRE>
<P>This means: a maximum of 1000 messages.</P>
<P>Don't forget to set quotawarning, otherwise no quota warning messages are issued.</P>
<H4><A NAME="quotawarning">8.1.1.18. quotawarning</A></H4>
<P>Custom text in quota warning message.</P>
<PRE>
    echo &quot;You can contact us at +49 40 12345678&quot; &gt; quotawarning
</PRE>
<P>Note: multiline. Supports the %HEADER% magic similar to qmail-reply. Default: NULL (no quota warnings will be issued!)</P>
<H4><A NAME="custombouncetext">8.1.1.19. custombouncetext</A></H4>
<P>Additional custom text in bounce messages, eg. for providing contact information. Multiline. Default: NULL</P>
<PRE>
    echo &quot;You can contact us at +49 40 12345678&quot; &gt; custombouncetext
</PRE>
<H4><A NAME="relaymailfrom">8.1.1.20. relaymailfrom</A></H4>
<P>This file contains envelope sender addresses that are allowed to relay through this server. This is a really bad idea as sender addresses are very easy to spoof and you are an open relay then. You should use SMTP after POP instead.</P>
<PRE>
    echo &quot;joe@yourdomain.com&quot; &gt; relaymailfrom
    echo &quot;@otherdomain.com&quot; &gt;&gt; relaymailfrom
</PRE>
<P>The first example allows joe@yourdomain.com to relay, the second one allows all addresses ending with @otherdomain.com to relay.</P>
<H4><A NAME="rbllist">8.1.1.21. rbllist</A></H4>
<P>Contains Realtime BlackList (RBL) servers addresses to check the given senders IP address against. There is further configuration needed to enable this, we'll discuss this later.</P>
<H4><A NAME="badrcptto">8.1.1.22. badrcptto</A></H4>
<P>Contains a list of local recipient addresses that are rejected. If the sender has RELAYCLIENT=&quot;&quot; set this file has no effect.</P>
<H4><A NAME="dirmaker">8.1.1.23. dirmaker</A></H4>
<P>If you compiled the autohomedirmake-feature, this contains the FULL path to your script which creates missing homedirs. The scrpit is executed under the affected user's uid/gid, so if your homedirs are in /home and the homdir for joe (system uid joe) should be created, joe MUST have write permissions to /home. This feature is most usefull in virtual user environments where all users are mapped to an single system uid/gid pair, let's say virtual/virtual. Then only virtual needs write permissions in /home. The script gets the path for the to be created homedir as first parameter and aliasempty as second one. A sample script:</P>
<PRE>
  #!/bin/sh
  mkdir -m 700 -p $1
</PRE>
<H4><A NAME="ldapcluster">8.1.1.24. ldapcluster</A></H4>
<P>One of qmail-ldap's  greatest features: native clustering support. If (and ONLY IF) you compiled cluster support in, you can enable clustering via this file:</P>
<PRE>
  echo 1 &gt; ldapcluster
</PRE>
<P>0 disables clustering.</P>
<H4><A NAME="ldapclusterhosts">8.1.1.25. ldapclusterhosts</A></H4>
<P>Alternate names for this host for use with clustering. For example, me contains mx1.example.com. ldapclusterhosts contains mx2.example.com. Every mail for users with either mx1.example.com or mx2.example.com in their mailHost attribute will be delivered locally.</P>
<P>Note: multiline Default: NULL</P>
<H4><A NAME="Missing Files">8.1.1.26. Missing Files</A></H4>
<P>Some files are currently missing in this description so please have a closer look at QLDAPINSTALL.</P>
<H3><A NAME="The LDAP Directory">8.1.2. The LDAP Directory</A></H3>
<P>All field names can be changed at compile time, see qmail-ldap.h. We are assuming the default field names here.</P>
<H4><A NAME="A sample user entry">8.1.2.1. A sample user entry</A></H4>
<PRE>
  dn: cn=brahe, ou=intern, ou=customer, dc=bsws, dc=de
  userpassword: {crypt}CENSORED
  cn: brahe
  ou: intern
  ou: customer
  objectclass: top
  objectclass: person
  objectclass: qmailuser
  mailhost: smtp.bsws.de
  mailmessagestore: /realhome/brahe/
  uid: brahe
  realname: Henning
  accountstatus: active
  mailquota: 100000000S, 10000C
  mailforwardingaddress: hostmaster@domino.bsws.de
  mail: brahe@smtp.bsws.de
  mailalternateaddress: hosting@mediadeck.de
  mailalternateaddress: henning@mediadeck.de
  mailalternateaddress: brauer@mediadeck.de
  mailalternateaddress: bsws@mediadeck.de
  mailalternateaddress: hostmaster@mediadeck.de
  mailalternateaddress: hbrauer@mediadeck.de
  mailalternateaddress: henning.brauer@mediadeck.de
  mailalternateaddress: catchall@2stupid.net
  mailalternateaddress: catchall@bsws.de
</PRE>
<P>Let's have a look at the fields.</P>
<PRE>
  dn
    Every entry in a LDAP directory has a &quot;distinguished name&quot;, dn in short.
    For persons it is normally build from the common name (cn), all
    organizational units (ou), and the basedn (dc=bsws, dc=de in this case).

  userpassword
    The userpassword, prefixed by the crypt-method. If no prefix is given,
    unix stadard crypt() is assumed (cleartext if you compiled with
    CLEARTEXTPASSWORD).
    Lots of other crypt methods like MD5 are possible. If you use rebinding
    (ldaprebind=1), all crypt methods supported by your ldap server are
    possible.

  cn
    common name - needed, unique

  ou
    organizational units - used to &quot;group&quot; users.

  objectclass
    defines the type of the ldap entry. multiple values are possible. Every
    entry to be used by qmail-ldap should have qmailuser as objectclass, but
    this isn't checked by default. Starting with patch 20010101, it is
    possible to check this.

  mailhost
    when clustering is turned on, the server where the user's mail is stored
    is defined here. Note that it MUST match the name given in &quot;me&quot; on the
    affected server.

  mailmessagestore
    where the user's mails should be stored. If you are starting qmail with
      qmail-start ./Maildir/
    (this is common), this would expand to /realhome/brahe/Maildir/.

  uid
    The username to be supplied for pop, imap, webmail and so on. unique.

  realname
    Hmmm... hard to guess what this could mean... ;-))

  accountStatus
    active: no restrictions
    nopop: pop3 access denied
    disabled: bounce incoming mails

  mailquota
    The users mailquota. In this example, 100 MB or 10000 Mails.

  mailforwardingaddress
    all mail received for this user is forwarded to this address. If
    deliverymethod isn't set to &quot;localdelivery&quot;,
    mail is only forwarded, no local copy stored.

  mail
    The users mail address. You can only set ONE mail attribute per user,
    and addresses must be unique. Use mailalternateaddress for additional
    addresses.

  mailalternateaddress
    additional mail address(es) for this user. Define as much as you want.
</PRE>
<P>There are more possible fields:</P>
<PRE>
  qmailUID
    The system uid for this user. If not set, the value from the control file
    &quot;ldapuid&quot; is taken (virtual user environment).

  qmailgid
    The system gid for this user, like qmailUID.

  homeDirectory
    The users home directory.
    If LDAP_HOMEDIR is found this field is used as $HOME, using
    aliasempty or mailMessagestore if defined as default delivery method.
    I recommend not to use this field, mailmessagestore is the cleaner
    approach.
    If you use this attribute for other purposes (in our case it's taken to
    chroot the user in this directory for ftp access), set LDAP_HOMEDIR in
    qmail-ldap.h to something different, noHomeDir is common.

  deliveryProgramPath
    same as |/path/to/someprog in a .qmail file. Only used if qmailDotMode
    is set to ldapwithprog or both.
    Example: /path/to/prog
        The program gets the message on STDIN. All environment variables as
    described in qmail-command(8) are set, and the exit code is handled
        exactly as described there. If, for example, the program exits 100 the
        mail is bounced.

  deliveryMode
    normal: Maildir/box delivery only if no forwards or prgrams are executed
    forwardonly: hmmm... hard to explain... ;-))
    nombox: ignore all maildir/mbox deliveries
    localdelivery: always deliver locally. In conjunction with forwarding
                   this means to deliver a local copy.
    reply: send also an auto-reply-mail with text from mailReplyText
    echo: don't use it, very strange.

    It is possible to set more than one value, be carefull.

  mailReplyText:
    The text for autoresponders. Only used if deliveryMode is set to &quot;reply&quot;.
</PRE>
<H3><A NAME="Access control with tcpserver">8.1.3. Access control with tcpserver</A></H3>
<P>Access control is done by tcpserver. tcpserver checks a cdb file if supplied via the -x parameter for the connection IP address. Cdb is a database format developed by Dan Berstein. If you are using the conf-qmail package the cdb files are in /service/[servicename]/tcp.cdb and are build from the file tcp in the same directory via the tcprules program. Check tcprules' man page for a description of its parameters. A basic tcp file looks like this:</P>
<PRE>
  192.168.1.1:allow
  192.168.2.:allow
  :deny
</PRE>
<P>The first line allows connections from 192.168.1.1, the second from the hole 192.168.2.0/24 subnet. Note that tcpserver does NOT work with subnet masks, the second line means exactly &quot;connections from all IP addresses beginning with 192.168.2. are allowed&quot;. The third line denies connections from any other address. It is possible to set environment variables through tcpserver via the tcp file. This is important for qmail-smtpd:</P>
<PRE>
  192.168.1.:allow,RELAYCLIENT=&quot;&quot;
  :allow
</PRE>
<P>This means: for connections from 192.168.1.* the environment variable RELAYCLIENT is set to &quot;&quot;, this means relaying is allowed to any destination. All other IPs may connect, but RELAYCLIENT is not set and therefore only RCTP TOs with domains from the control file rcpthosts are accepted. It is also possible to set more than one environment variable:</P>
<PRE>
  192.168.1.:allow,RELAYCLIENT=&quot;&quot;,MYVAR1=&quot;value&quot;,MYVAR2=&quot;&quot;
</PRE>
<P>Let's have a short look at the control files needed for qmail-ldap operation. The most important piece is qmail-smtpd. You need a tcp file where the environment variable RELAYCLIENT is set to &quot;&quot; for all your local IPs. Connections from all other IPs are normally allowed, but RELAYCLIENT isn't set. For roaming clients we need an additional solution - read on ;-)) For qmail-qmtpd the same rules apply, it is common to use the same tcp.cdb for smtp and qmtp. For qmail-qmqpd it is very important to deny connections by default. There's no relay checking for qmqp! For pop3 and imap tcpserver is normally invoked without a tcp.cdb to check as we normally allow access from anywhere.</P>
<H3><A NAME="startup scripts">8.1.4. startup scripts</A></H3>
<P>qmail-ldap comes with daemontools service run scripts in /var/qmail/boot The scripts should be ready to use and include samples for qmail, pop3, imap, smtp, qmqp, pbsdbd, pop3-ssl and imap-ssl.</P>
<P>This is a bit tricky. I would really recommend using <A HREF="http://www.din.or.jp/~ushijima/qmail-conf.html">qmail-conf</A> by Tetsu Ushijima. He has written an excellent documentation for qmail-conf, read it. qmail-conf requires djbdns to be installed.</P>
<H4><A NAME="pop3">8.1.4.1. pop3</A></H4>
<P>Use qmail-pop3d-conf from the qmail-conf package:</P>
<PRE>
  qmail-pop3d-conf /var/qmail/bin/auth_pop qmaill /var/qmail/service/pop3d
</PRE>
<P>The only difference to Tetsu's documentation: we use another authentification program of course - auth_pop.</P>
<H4><A NAME="imap">8.1.4.2. imap</A></H4>
<P>Ther preferred IMAP server for qmail-ldap is courier imap. Get it from http://www.inter7.com/courierimap/. You can and should start courier imap using tcpserver and auth_imap. Your run file will look like this:</P>
<PRE>
  #!/bin/sh

  exec_prefix=/usr/lib/courier-imap
  . /etc/imapd.config

  tcpserver -c 100 -l imap.bsws.de -v -R 213.128.133.139 imap \
    ${exec_prefix}/sbin/imaplogin \
    /var/qmail/bin/auth_imap \
    ${exec_prefix}/bin/imapd Maildir  2&gt;&amp;1
</PRE>
<H2><A NAME="webmail">8.2. webmail</A></H2>
<P>It's quite common to use sqwebmail with qmail-ldap. If there were an award for the fastest webmail program on earth sqwebmail would get it. It accesses Maildirs directly and is written in C. Get it from http://www.inter7.com/sqwebmail/. Right now you cannot use sqwebmail in a cluster in a clean way.</P>
<P>Alternatively you can use any webmail program working over IMAP. <A HREF="http://www.squirrelmail.org/">squirrelmail</A> gained popularity the last few years. Horde's <A HREF="http://www.horde.org/imp/">IMP</A> is another common choice, though not my one.</P>
<H2><A NAME="Cluster">8.3. Cluster</A></H2>
<P>One of qmail-ldap's greatest features: its native clustering support.</P>
<H3><A NAME="How clustering works with qmail-ldap">8.3.1. How clustering works with qmail-ldap</A></H3>
<P>It unbelievable simple. In a cluster enabled qmail-ldap environment, every host has all domains to be handled by the cluster both in rcpthosts and locals. When a message is received, the user is looked up and his mailHost attribute is compared to the control files &quot;me&quot; and &quot;ldapmailhost&quot;. If mailHost doesn't match either, the mail is forwarded to mailHost via qmqp. There is also pop3- and imap-session forwarding, these are handled by auth_pop and auth_imap.</P>
<P>Important note: all hostnames (especially those in mailHost and me) MUST be valid dns names, qmail does NEVER use /etc/hosts.</P>
<H3><A NAME="setting up the cluster">8.3.2. setting up the cluster</A></H3>
<P>As in-cluster delivieries are done via qmqp, you'll need to set up qmail-qmqpd on all cluster members. Use qmail-qmqpd-conf from the qmail-conf package for that. Don't forget to add your cluster hosts IP-addresses to /service/qmqpd/tcp on each cluster member, otherwise in-cluster deliveries will fail.</P>
<P>You'll need to decide on which cluster member each user should have his/her mail stored, set mailHost for each user accordingly.</P>
<P>Add all domains to be handled by the cluster to the control files rcpthosts and locals on all cluster members - rsync is your friend ;-))</P>
<P>This should be all. It's now time to enable clustering (echo 1 &gt; /var/qmail/control/ldapcluster) and start qmail-ldap on each cluster member.</P>
<P>Make sure you have set up pop3 (and possibly imap) on all cluster members storing users mail (important: they _must_ listen on the ip address defined by `me`!) , otherwise session forwarding will fail. If you need imap, you have to use courier imap under tcpserver with auth_imap, otherwise imap session forwarding won't work.</P>
<H2><A NAME="domain aliassing">8.4. domain aliassing</A></H2>
<P>Given your eMail addresses are in the form user@domain.com and your mailserver is called mail.domain.com you may wish to have each user reachable as user@mail.domain.com, too. You can of course just add additional mailAlternateAddress attributes to each user record, but this may be lots of work for big directories. another possibility is making mail.domain.com an alias for domain.com. You need to remove mail.domain.com from control/locals and add it to control/virtualdomains like</P>
<PRE>
  mail.domain.com:mail.domain.com
</PRE>
<P>Then, add a file alias/.qmail-mail:domain:com-default containing</P>
<PRE>
  |/var/qmail/bin/forward $DEFAULT@domain.com
</PRE>
<P>It is important to use the forward program here instead of just writing $DEFAULT@domain.com in the file. The environment variables like $DEFAULT are only available when doing program deliveries. Also make sure you have localdeliveries turned on. In the .qmail-filename all dots must be replaced by : as described in qmail-local's manpage.</P>
<H2><A NAME="dash extension adressing explained">8.5. dash extension adressing explained</A></H2>
<P>Let's hav a look at an example. A mail for joe-average-user-list@domain.com comes in. qmail-ldap will look for mail: and alternateMailAddress: attributes in the following order and taking the first match:</P>
<PRE>
  joe-average-user-list@domain.com
  joe-average-user-catchall@domain.com
  joe-average-catchall@domain.com
  joe-catchall@domain.com
  catchall@domain.com
</PRE>
<P>got the logic? we start with looking for a exact match. if that fails, we replace everything in the local part after the last dash with catchall, then everything after the 2nd last dash, and so on until only catchall is left.</P>
<HR>
<H1><A NAME="Comparison with stock qmail, migration issues">9. Comparison with stock qmail, migration issues</A></H1>
<P>Volunteers?</P>
<HR>
<H1><A NAME="Testing configs, diagnosing problems">10. Testing configs, diagnosing problems</A></H1>
<P>Volunteers?</P>
<HR>
<H1><A NAME="Performance">11. Performance</A></H1>
<P>yes, performs great!</P>
<HR>
<H1><A NAME="The qmail-ldap-control patch">12. The qmail-ldap-control patch</A></H1>
<P>This patch is by Turbo Fredriksson who wrote the following documentation for his patch, too.</P>
<H2><A NAME="Basics">12.1. Basics</A></H2>
<H3><A NAME="Where to find the patch">12.1.1. Where to find the patch.</A></H3>
<P>The latest QmailLDAP/Control patch is <A HREF="http://qmail.bayour.com/patches_ldap/">here</A></P>
<UL>
</UL>
<H3><A NAME="Notes about usage">12.1.2. Notes about usage.</A></H3>
<P>You must first have patched your qmail source tree with the QmailLDAP patch (see above) before you attempt in using the QmailLDAP/Control patch. You should also have succeeded in getting QmailLDAP to work and deliver messages. Using another LDAP patch will only introduce yet another point-of-error, so one thing at a time, please :). It will make all of us happier, and makes it easier at helping you at all.</P>
<H3><A NAME="What is it? What does it do">12.1.3. What is it? What does it do?</A></H3>
<P>We are here make a distinction between QmailLDAP (which is the original qmail-ldap patched system) and QmailLDAP/Controls (which is qmail-ldap patch and the special ldap controls patch).</P>
<P>This patch makes it possible to store all the information that qmail usually gets from the controls file (usually in /var/qmail/control/) from your LDAP server instead of reading files.</P>
<H3><A NAME="Main reason for usage">12.1.4. Main reason for usage.</A></H3>
<P>The main reason for this patch was having a centralised configuration of qmail. My point was to have relativly unexperienced qmail/unix personnel in my organisation to do the 'trivial configuration stuff' such as adding domains to the locals and rcpthosts files. This can quite easily made even by a sales-person like Stef :)</P>
<P>Using a simple webinterface and spending some thoughts when setting up multiple qmail servers (either as a cluster, or standalones), you can have all the configuration in one place (under the same Control DN in the LDAP database), thus making it harder for the unexperienced people to forget a host when modifying system-wide information.</P>
<H3><A NAME="Files still needed for startup">12.1.5. Files still needed for startup.</A></H3>
<P>Basically the only FILES you still need in the control directory are 'me', 'ldapcontroldn' and 'ldapserver'.</P>
<P>This is because qmail need to know who it is ('me'). This is Fully Qualified Domain Name (or FQDN for short) for the host running qmail. This information is used by QmailLDAP/Controls to find the proper LDAP object for this particular qmail host. qmail also needs to know WHERE to find the information in the database ('ldapcontroldn'). It will search below the Distinguished Name specified in the 'ldapcontroldn' file. And naturally qmail needs to know WHERE the LDAP server is running ('ldapserver').</P>
<P>If you want to limit access to what information is stored in the QmailLDAP/Controls object, you can put the proper ACL's in your LDAP server and have QmailLDAP/Controls bind with a special Bind DN and password. This information is then specified in the files 'ldaplogin' and 'ldappassword'.</P>
<P>REMEMBER: The 'ldaplogin' is a Distinguished Name entry, NOT a user name!</P>
<P>Just in case your LDAP server isn't running on the default port 389 you can specify the port in the file 'ldapport'.</P>
<H2><A NAME="Installation: qmail-ldap-control">12.2. Installation: qmail-ldap-control</A></H2>
<H3><A NAME="Applying the patch and customise Makefile to reflect your setup">12.2.1. Applying the patch and customise Makefile to reflect your setup.</A></H3>
<P>After getting the patch, you can apply the patch by using this command string (in the qmail source tree):</P>
<PRE>
    gzip -cd path_to_patch/qmail-ldap-control_20001211.patch.gz | patch -p1
</PRE>
<P>Replace 'path_to_patch' with the full path to the location where you saved the patch you downloaded (see above).</P>
<P>Now it's time to modify the Makefile to reflect your setup. You can change the following values:</P>
<PRE>
    CONTROLDB=-DUSE_CONTROLDB
         To enable having the configuration (~control/*) in the
         LDAP database to, uncomment this line.
</PRE>
<H3><A NAME="Modify the configuration for your LDAP server">12.2.2. Modify the configuration for your LDAP server.</A></H3>
<P>While QmailLDAP/Controls compiles, you can start by modifying your LDAP server. We must tell it what object classes and attributes that have to do with the QmailLDAP/Controls system. The specification about the object class  and the attributes  can be found at the bottom of the QLDAPINSTALL file. Please look in this file for the latest definition of the object class. If you are using LDAP v3  (that is, OpenLDAP v2.x) you should use the schema  supplied as  qmailControl.schema.  This file  goes into  your OpenLDAP  schema repository (ie,  where the  other .schema  files are located). They you  will have to include this  file in the slapd.conf file. After the qmail.schema include is a good bet.</P>
<P>When this is done, restart the LDAP server (or make it reread the new configuration).</P>
<H3><A NAME="Move control information to the LDAP database">12.2.3. Move control information to the LDAP database.</A></H3>
<P>Now go through each file in the control directory and create a LDIF out of those values. The way the patch works, all you have to do is use the filename as the attribute. For example, if you have a file there by the name 'locals' (a very common file in qmail), the attribute for each line in this file is 'locals'. And likewise, the file refered to as '~controls/ldapuid' in the QLDAPINSTALL file, would have a attribute name of 'ldapuid' etc.</P>
<H2><A NAME="Example Configurations - move the control files to ldap">12.3. Example Configurations - move the control files to ldap</A></H2>
<H3><A NAME="Basic LDAP object">12.3.1. Basic LDAP object.</A></H3>
<P>First thing we should do is decide WHERE (ldapcontroldn) we should have our QmailLDAP/Controls object. I have (on my company's system) decided to create my database with the 'location' system. That is, I'm from Sweden, and my company works mostly/currently only in Sweden. I have therefore specified the BaseDN to  be 'c=SE'. Our company is called 'Air2Net',  so  therefore  our branch  in  the  tree  is 'o=Air2Net'. Under this, I have created a 'organizationUnit' with the name 'ou=QmailLDAP'.  And  the mail server  is  called 'donald.air2.net'. The full DN for the QmailLDAP/Controls object for Donald is therefore:</P>
<PRE>
    cn=donald.air2.net,ou=QmailLDAP,o=Air2Net,c=SE
</PRE>
<P>So the first lines in the LDIF we are creating is this (we include the object classes at the same time here):</P>
<PRE>
    dn: cn=donald.air2.net,ou=QmailLDAP,o=Air2Net,c=SE
    objectclass: top
    objectclass: qmailControl
    cn: donald.air2.net
</PRE>
<H3><A NAME="Moving the \'locals\' file to LDAP">12.3.2. Moving the 'locals' file to LDAP.</A></H3>
<P>To show the usage of the LDAP database, I will demonstrate how to move the 'locals' file to LDAP. The locals file is, as I said earlier, a very common file in the qmail world, it is why I choose to demonstrate with this file.</P>
<P>This  is  a genuine  example  from  my  own file  (before QmailLDAP/Controls):</P>
<PRE>
        4pl.nu
        air2.net
        alho.net
        antique-on-net.com
        claesbuhler.com
        companyregister.com
        companyregister.net
        companyregister.ws
        donald.air2.net
        donald.fotbollextra.org
        donald.modular-telecom.se
        donald.test.org
        donald.winas.com
        fotbollextra.org
        fraktmaklarna.se
        heyman.nu
        localhost
        logisticsolutions.nu
        mail.air2.net
        mail.nbk.se
        modular-telecom.se
        nbk.se
        samba.se
        system2.net
        test.org
        thegamestudio.com
        westcoastit.com
        winas.com
</PRE>
<P>To create a LDIF out of this, just add a 'locals: ' before each line, like this:</P>
<PRE>
  locals: 4pl.nu
  locals: air2.net
  locals: alho.net
  locals: antique-on-net.com
  locals: claesbuhler.com
  locals: companyregister.com
  locals: companyregister.net
  locals: companyregister.ws
  locals: donald.air2.net
  locals: donald.fotbollextra.org
  locals: donald.modular-telecom.se
  locals: donald.test.org
  locals: donald.winas.com
  locals: fotbollextra.org
  locals: fraktmaklarna.se
  locals: heyman.nu
  locals: localhost
  locals: logisticsolutions.nu
  locals: mail.air2.net
  locals: mail.nbk.se
  locals: modular-telecom.se
  locals: nbk.se
  locals: samba.se
  locals: system2.net
  locals: test.org
  locals: thegamestudio.com
  locals: westcoastit.com
  locals: winas.com
</PRE>
<H3><A NAME="Moving QmailLDAP information to LDAP">12.3.3. Moving QmailLDAP information to LDAP.</A></H3>
<P>The information QmailLDAP needs can naturally also be put in the LDAP server. The most common information QmailLDAP uses are ldapbasedn, ldapuid, ldapgid and ldapdefaultquota etc. To add that information to the QmailLDAP/Controls object, we add these lines to the LDIF (remember, the 'ldapbasedn' is where QmailLDAP will search for USERS, and 'ldapcontroldn' is where QmailLDAP/Controls will search for control information):</P>
<PRE>
  ldapbasedn: c=SE
  ldapuid: 3001
  ldapgid: 3000
  ldapdefaultquota: 10000
</PRE>
<P>Create the LDIF out of your remaining files, moving the information one by one.</P>
<H3><A NAME="Resulting LDIF to load to the LDAP database">12.3.4. Resulting LDIF to load to the LDAP database.</A></H3>
<P>The resulting LDIF that we in this example should load to the database are as follows:</P>
<PRE>
  dn: cn=donald.air2.net,ou=QmailLDAP,o=Air2Net,c=SE
  objectclass: top
  objectclass: qmailControl
  cn: donald.air2.net
  locals: 4pl.nu
  locals: air2.net
  locals: alho.net
  locals: antique-on-net.com
  locals: claesbuhler.com
  locals: companyregister.com
  locals: companyregister.net
  locals: companyregister.ws
  locals: donald.air2.net
  locals: donald.fotbollextra.org
  locals: donald.modular-telecom.se
  locals: donald.test.org
  locals: donald.winas.com
  locals: fotbollextra.org
  locals: fraktmaklarna.se
  locals: heyman.nu
  locals: localhost
  locals: logisticsolutions.nu
  locals: mail.air2.net
  locals: mail.nbk.se
  locals: modular-telecom.se
  locals: nbk.se
  locals: samba.se
  locals: system2.net
  locals: test.org
  locals: thegamestudio.com
  locals: westcoastit.com
  locals: winas.com
  ldapbasedn: c=SE
  ldapuid: 3001
  ldapgid: 3000
  ldapdefaultquota: 10000
</PRE>
<P>Simply use 'ldapadd' (distributed with OpenLDAP) to load the LDIF, or use the tools that came with your LDAP server to do this instead.</P>
<H3><A NAME="Content of existing files after move to LDAP">12.3.5. Content of existing files after move to LDAP.</A></H3>
<P>Now when we have moved all of the information from files to the LDAP database, we should only have the remaining files in the control directory:</P>
<H3><A NAME="Content of existing files after move to LDAP">12.3.6. Content of existing files after move to LDAP.</A></H3>
<PRE>
  File                  Content
  ===========================================================
  ldapcontroldn         ou=QmailLDAP,o=Air2Net,c=SE
  ldapserver            ldap.air2.net
  me                    donald.air2.net
</PRE>
<P>That's it, the rest of the information that QmailLDAP needs, is retreived from the LDAP server instead!</P>
<P>Important Note: you SHOULD keep a rcpthosts file which may contain only yuour own hostname or somesuch, just in case of a misfunction. without a rcphosts file, qmail (specifically, qmail-smtpd's behaviour) is an Open Relay. Should anything wrt the LDAP lookup go nuts, you are only safe if still having the rcpthosts file.</P>
<HR>
<H1><A NAME="Additional Patches">13. Additional Patches</A></H1>
<H2><A NAME="SMTP after POP">13.1. SMTP after POP</A></H2>
<P>After patching you need to enable SMTP after POP by adding -DSMTP_AFTER_POP to LDAPFLAGS in Makefile.</P>
<P>As we all know, SMTP does not contain any authentification mechanisms by default. So in practice you are allowing realying through your server only for some IP addresses, normally your corporate network. If your users are coming from various, dynamic IP addresses they can't use your mailserver for sending :-((</P>
<P>To overcome this limitation there are 3 possibilities:</P>
<UL><UL>
<LI>relaying based on the envelope sender - a really bad idea, easy to abuse.
<LI>SMTP AUTH - great, but your clients need to support it. For a patch see below.
<LI>SMTP after POP - when the user gets his mail through pop, his IP address is recorded and the permission to relay is given for this IP for something about half an hour.</UL></UL>
<P>SMTP AUTH would be the best solution as username and password are supplied when sending, but as long as too many clients are lacking support for it, this is not an option for most of us.</P>
<P>Therefore I have written a patch for qmail-ldap to allow SMTP after POP. There is another solution without the need for a patch because it parses logfiles - I don't like this approach, and the patch should perform better. It is based on Russel Nelson's open-smtp.</P>
<P>For first, we need to patch auth_pop to call an external script when a user authentificated. tcpserver (under which the pop-daemon runs) sets fortunately some environment variables, one of them contains the remote host's IP. My patch sets an additional environment variable: AUTHUSER. It contains the authentificated username.</P>
<P>You can get the patch <A HREF="http://www.lifewithqmail.org/ldap/patches/smtp-after-pop/">here</A>.</P>
<P>Then we need the external script, it is called /usr/local/bin/pop3-record. A sample script:</P>
<PRE>
  #!/bin/sh
  echo &quot;$TCPREMOTEIP:allow,RELAYCLIENT=\&quot;\&quot;,TCPREMOTEINFO=\&quot;$AUTHUSER\&quot;&quot; &gt;&gt; /service/qmail-smtpd/tcp.filter.newer
  cat /service/qmail-smtpd/tcp.filter.* /service/qmail-smtpd/tcp | tcprules /service/qmail-smtpd/tcp.cdb /service/qmail-smtpd/tcp.cdb.$$
</PRE>
<P>Beware that this script will cause serious trouble when used with an IPv6-aware tcpserver and someone connects to your pop3-server over IPv6! Don't forget to modify the pathes if needed! The first line records the IP and abuses TCPREMOTEINFO to store the authentificated username in the mail header. The second line builds the cdb qmail-smtpd uses to decide wether relaying is allowed or not.</P>
<P>Some Notes about AUTHUSER: For basic smtp after pop operation you don't need AUTHUSER at all. Whenever your client authentificates via pop3 his IP is allowed to relay until your cron job removes it. The idea behind setting TCPREMOTEINFO to AUTHUSER is to store the authentificated user name in the header of outgoing mails from him so it is really easy to determine which user has sent a mail in case of abuse reports. If you don't want this, just remove the ,TCPREMOTEINFO=&quot;$AUTHUSER&quot; from pop3-record.</P>
<P>TCPREMOTEINFO is normally used to store the username you get by ident, this has no practical relevance any more as nearly no client runs ident. So we are invoking tcpserver with the according option (-R) to not query ident information and abusing the TCPREMOTEINFO to store our authentificated username.</P>
<P>The user's IP is now allowed to relay infinite - this is not what we want. Therefore, run somthing like the following every 15 mins (or whatever you like) by cron:</P>
<PRE>
  #!/bin/sh
  mv /service/qmail-smtpd/tcp.filter.newer /service/qmail-smtpd/tcp.filter.older
  cat /service/qmail-smtpd/tcp.filter.* /service/qmail-smtpd/tcp | tcprules /service/qmail-smtpd/tcp.cdb /service/qmail-smtpd/tcp.cdb.$$
</PRE>
<P>That's all! Simple, eh?</P>
<P>Arek Dreyer has some extended scripts, I'll put a tgz to the download location.</P>
<P>I'm preparing a similar patch for auth_imap, will call the same script and will be available at the usual place.</P>
<H2><A NAME="SMTP AUTH">13.2. SMTP AUTH</A></H2>
<P>As described above SMTP AUTH is the cleanest solution for allowing roaming clients to use your smtp-server. David E. Storey &lt;dave@tamos.net&gt; has ported the patch from brush/elysium.pl to qmail-ldap. I have written auth_smtp for authentication. After installing the patch you must modify your qmail-smtpd startup file, qmail-smtpd needs two options now:</P>
<PRE>
  qmail-smtpd /var/qmail/bin/auth_smtp /usr/bin/true
</PRE>
<P>The second parameter isn't used but must exist. If you wan't to be able to authenticate system users on a shadow password system auth_smtp must be suid root. Otherwise it runs fine without special permissions.</P>
<P>Get it <A HREF="http://www.lifewithqmail.org/ldap/patches/smtp-auth/">here</A>.</P>
<P>Some common problems:</P>
<P>1. &quot;I still can send mail without authenticating&quot;</P>
<P>Read RFC2554. SMTP AUTH is just an OFFER for the client to authenticate itself to get relaying permissions. If he already has relaying permissions (through IP-based selective relaying aka tcpserver for example) he wins nothing through the authentification.</P>
<P>2. permissions on /var/qmail/bin/auth_smtp</P>
<P>qmail-smtpd must be able to run auth_smtp. qmail-smtpd normally runs as user qmaild. auth_smtp should be owned by root and mode 755 (default, but check it - there was an error regarding this in older versions of the patch) or owned by qmaild and mode 700. If you want to auth system users from shadow password files (/etc/shadow typically) auth_smtp must be setuid root. I don't recommend this.</P>
<P>3. permissions on ~/control/ldap*</P>
<P>auth_smtp MUST be able to read the control files containing informations about the ldap server, especially ldapserver, ldapbasedn and ldappassword (if existant). Pay attention to ldappassword! auth_smtp usually runs as user qmaild and must be able to read this file if you aren't using anonymous binds against your ldap server.</P>
<P>Please note that the patch isn't declared stable or so, it is still experimental. It works fine on my production systems since march or so, but I know there are some gotchas and unclear error messages left.</P>
<H2><A NAME="The Dash-Trick">13.3. The Dash-Trick</A></H2>
<P>This patch is slightly modified included as of 20011001.</P>
<P>After patching you need to enable the dash-extension by adding -DDASH_EXT to LDAPFLAGS in Makefile.</P>
<P>If you have the address joe@domain.com in stock qmail, you also have joe-[anything]@domain.com. This isn't the case with qmail-ldap. As ezmlm relies on this, I've written a patch based on the work by Cedric Schieli.</P>
<P>Get it <A HREF="http://www.lifewithqmail.org/ldap/patches/dash-trick/">here</A>.</P>
<H2><A NAME="MXPS and QMTP for qmail-remote">13.4. MXPS and QMTP for qmail-remote</A></H2>
<P>After patching you need to enable MXPS and QMTP by adding -DMXPS to LDAPFLAGS in Makefile.</P>
<P>Dan Bernstein describes <A HREF="http://cr.yp.to/proto/mxps.txt">MXPS</A>, the Mail eXchanger Protocol Switch. This allows the use of alternative protocols like <A HREF="http://cr.yp.to/proto/qmtp.txt">QMTP</A> instead of SMTP. The MX's priority field in DNS is abused for protocol selection. lets have a look at bsws.de for example:</P>
<PRE>
  # dnsmx bsws.de | sort
  12801 mx01.bsws.de  (-&gt; QMTP)
  12816 mx01.bsws.de  (-&gt; SMTP)
  12817 mx02.bsws.de  (-&gt; QMTP)
  12832 mx02.bsws.de  (-&gt; SMTP)
</PRE>
<P>This tells MXPS-capable remote servers (or clients) to send via QMTP to mx01 first, if this fails, via SMTP to mx01 and so on. Non-MXPS-capable clients just send to mx01 with SMTP (therefore it is important that every server understands SMTP and not only QMTP). QMTP has shown to be at least twice as fast as SMTP in most cases.</P>
<P>Russel Nelson has written a patch for qmail-remote to use MXPS and, if QMTP support is announced by MXPS, use QMTP to deliver mail. The QMTP code itself is taken from Dan's serialmail package.</P>
<P>I have adapted Russel's patch to qmail-ldap, get it <A HREF="http://www.lifewithqmail.org/ldap/patches/">here</A>.</P>
<P>In order to receive messages via qmtp, set up qmail-qmtpd (use conf-qmail-qmtpd) and set the MX priorities for your domain(s) according to the above example.</P>
<H2><A NAME="RBL Tagging">13.5. RBL Tagging</A></H2>
<P>qmail-ldap can block messages from servers listed on various rbl lists by default. Inspired by Maex extension to rblsmtpd I've patched qmail-smtpd and qmail-qmtpd to tag messages from blacklisted servers. Whenever a mail from a blacklisted server is received qmail-smtpd/-qmtpd adds an X-RBL-Check: [blacklistserver] Header. So, if a mail from 1.2.3.4 is received and this server is blacklisted on rbl.domain.com and rbl.otherservice.com, the two lines</P>
<PRE>
  X-RBL-Check: rbl.domain.com
  X-RBL-Check: rbl.otherservice.com
</PRE>
<P>will be added to the message's header.</P>
<P>To enable this you'll need to apply the <A HREF="http://www.lifewithqmail.org/ldap/patches/rbltag/">patch</A> and create the new control file rbltags, listing the rbl-servers to check against, one per line. Please note that the qmtpd part is nearly untested, I appreciate any feedback.</P>
<P>Maex has <A HREF="http://www.lamer.de/maex/creative/software/mess822/822xrblcheck/">822xrblcheck</A>, a small program to be used in conjunction with bouncesaying allowing users to reject mails with X-RBL-Check headers in their .qmail-files.</P>
<P>qmail-ldap with patch 20010501 and above has a similar functionality, but I don't like the implementation, especially you must decide to either reject connections from blacklisted hosts or tag messages. You cannot, for example, reject messages from hosts listed in really-well-known-spammers.corp.local and tag messages from hosts in dialups.corp.local. My patch allows this.</P>
<HR>
<H1><A NAME="Installing packages">A. Installing packages</A></H1>
<H2><A NAME="Manual source install">A.1. Manual source install</A></H2>
<H3><A NAME="daemontools">A.1.1. daemontools</A></H3>
<P>Get daemontools from <A HREF="http://cr.yp.to/daemontools/install.html">http://cr.yp.to/daemontools/install.html</A>. Installation is really easy:</P>
<PRE>
    mkdir -p /package
    chmod 1755 /package
    cd /package
    gunzip /path/to/daemontools-0.76.tar.gz
    tar -xf daemontools-0.76.tar
    rm daemontools-0.76.tar
    cd admin/daemontools-0.76
    package/install
</PRE>
<H4><A NAME="Linux">A.1.1.1. Linux</A></H4>
<P>inittab vs /etc/rc.d/ vs some kind of sysv-style init</P>
<H4><A NAME="OpenBSD, NetBSD">A.1.1.2. OpenBSD, NetBSD</A></H4>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>This is not needed for daemontools &gt;= 0.75 !
<HR WIDTH="80%" ALIGN="Left"></P>
<P>On OpenBSD and NetBSD, you would add these lines to your /etc/rc.local:</P>
<PRE>
  echo -n &quot;daemontools &quot;
  PATH=$PATH:/usr/local/bin
  svscan /service &amp;
</PRE>
<H4><A NAME="FreeBSD">A.1.1.3. FreeBSD</A></H4>
<P><HR WIDTH="80%" ALIGN="Left">
<STRONG>Note: </STRONG>This is not needed for daemontools &gt;= 0.75 !
<HR WIDTH="80%" ALIGN="Left"></P>
<P>Arek Dreyer has a sample /etc/rc.local file [for FreeBSD 4.1]:</P>
<PRE>
  #!/bin/sh
  # This file is /etc/rc.local
  #
  if [ -r /etc/defaults/rc.conf ]; then
        . /etc/defaults/rc.conf
        source_rc_confs
  elif [ -f /etc/rc.conf ]; then
        . /etc/rc.conf
  fi
  #
  case ${daemontools_enable} in
    [Yy][Ee][Ss])
        if [ -x /usr/local/bin/svscan ]; then
                echo -n ' daemontools';
                PATH=/usr/local/bin:/usr/sbin:/usr/bin:/bin \
                svscan /service &amp;
        fi
        ;;
  esac

  case ${slapd_enable} in
    [Yy][Ee][Ss])
        if [ -r /usr/local/etc/openldap/slapd.conf ]; then
                echo -n ' slapd';
                /usr/local/libexec/slapd ${slapd_flags}
        fi
        ;;
  esac

  case ${sshd_enable} in
    [Yy][Ee][Ss])
        if [ -x ${sshd_program:-/usr/sbin/sshd} ]; then
                echo -n ' sshd';
                ${sshd_program:-/usr/sbin/sshd} ${sshd_flags}
        fi
        ;;
  esac
</PRE>
<H4><A NAME="Solaris 8">A.1.1.4. Solaris 8</A></H4>
<P>Required Software - Newer versions may be substituted normally. Most packages are available <A HREF="ftp://ftp.sunet.se/pub/vendor/sun/freeware/sparc/8/">here</A>.</P>
<PRE>
  GCC version 2.95.2
  Autoconf 2.13
  Automake 1.4
  Make 3.79
  GDBM 1.7.3
  Openldap 1.2.11 from ftp.openldap.org
  Qmail 1.03 as usual
  qmail-ldap patch as usual
</PRE>
<P>Autoconf, Automake, Make, &amp; GDBM all use the same installation method:</P>
<PRE>
  gzip -d gdbm-1.7.3-sol7-sparc-local.gz
  pkgadd -d gdbm-1.7.3-sol7-sparc-local
</PRE>
<P>save Openldap, qmail, and qmail-ldap sources in /usr/local/src</P>
<PRE>
  gzip -d *.gz
  tar xvf *.tar

  cd /usr/local/src/openldap-1.2.11
  env CPPFLAGS=-I/usr/local/include LDFLAGS=-L/usr/local/lib LIBS=&quot;-lpthread -lposix4&quot; ./configure --with-ldbm-api=gdbm
  make depend; make; make install
</PRE>
<P>Use the AR that works with GCC:</P>
<PRE>
  ln -s  /usr/ccs/bin/ar /usr/bin/ar
</PRE>
<P>Now qmail-ldap itself:</P>
<PRE>
  Add qmail groups and users now per qmail INSTALL
  cd /usr/local/src/qmail-1.03
  gpatch -p1 &lt; ../qmail-ldap-1.03-[version].patch
</PRE>
<P>vi conf-ld to say  gcc -s  and conf-cc to say  gcc -02. vi Makefile, set opions as desribed above, additionally uncomment the shadowopts line and add -lnsl -lsocket to LDAPLIBS line.</P>
<PRE>
  make setup check
  ./config
</PRE>
<H3><A NAME="ucspi-tcp">A.1.2. ucspi-tcp</A></H3>
<P>You need ucspi-tcp from <A HREF="http://cr.yp.to/ucspi-tcp/install.html">http://cr.yp.to/ucspi-tcp/install.html</A>. Installation is once more really simple:</P>
<PRE>
    gunzip ucspi-tcp-0.88.tar.gz
    tar -xf ucspi-tcp-0.88.tar
    cd ucspi-0.88
    make
</PRE>
<P>Become root once more for the installation:</P>
<PRE>
    make setup check
</PRE>
<P>That's all. No configuration needed.</P>
<HR>
<H1><A NAME="typical problems">B. typical problems</A></H1>
<H2><A NAME="shared library problems">B.1. shared library problems</A></H2>
<P>When I try to start qmail-ldap I'm getting this error: alert: cannot start qmail-lspawn or it had an error! Check if ~control/ldapserver exists.</P>
<P>The control file ldapserver exists and has correct permissions (644). What's the problem?</P>
<P>If the control file ldapserver exists then it seems that qmail-lspawn crashed while starting. This is because of missing shared libraries. Since OpenLDAP has started to compile normally shared libs we see this reports more often on the mailing list.</P>
<P>To see if you have a shared library problem try this: `env - /var/qmail/bin/qmail-lspawn` or even better `env - /var/qmail/bin/qmail-ldaplookup -m someone@somewhere.org` if you get something like: /var/qmail/bin/qmail-ldaplookup: error in loading shared libraries libldap.so.1: cannot open shared object file: No such file or directory you have a shared library problem.</P>
<P>Also a `ldd /var/qmail/bin/qmail-ldaplookup` should mention that problem: (Output of a Linux test box)</P>
<PRE>
        libldap.so.1 =&gt; not found
        liblber.so.1 =&gt; not found
        libc.so.6 =&gt; /lib/libc.so.6 (0x40007000)
        /lib/ld-linux.so.2 =&gt; /lib/ld-linux.so.2 (0x00000000)
</PRE>
<P>How to solve the problem: 1. find your ldap libs, you should know where they are. In my case /opt/OpenLDAP/lib</P>
<P>Super fast hack: ln -s them /usr/lib and probably rerun ldconfig</P>
<P>Fast hack: set the env-var LD_LIBRARY_PATH to &quot;/path/to/OpenLDAP/lib&quot; e.g. in /var/qmail/rc via a &quot;env LD_LIBRARY_PATH=/opt/OpenLDAP/lib&quot;</P>
<P>Better: add it to the ld.cache. On many systems there are tools like ldconfig. You can use them to add /opt/OpenLDAP/lib to the normal runtime library search path. Under linux you can edit /etc/ld.so.conf. Under *BSD you can use ldconfig /opt/OpenLDAP/lib to add it to the cache AFAIK there is also something like /etc/ld.so.conf on Solaris.</P>
<P>Best: recompile qmail-ldap with adding -R/opt/OpenLDAP/lib to LDAPLIBS This works under Solaris and OpenBSD sparc other OS's may also support it. Under Linux you have to use ld as linker (conf-ld) and add a -rpath /opt/OpenLDAP/lib to LDAPLIBS</P>
<HR>
<H1><A NAME="Operating System specifics">C. Operating System specifics</A></H1>
<HR>
<H1><A NAME="qmail-ldap and ezmlm">D. qmail-ldap and ezmlm</A></H1>
<P>In order to use ezmlm with qmail-ldap, you need to enable dash-ext adressing in qmail-ldap. Ezmlm uses listname-directive@domain.com for various things, so your mail server must be able to handle this.</P>
<P>Once you have done this, run the ezmlm-make program as usual. Once you have your list, create an ldap entry for the 'main list' address. Set the mail or mailalternateaddress attribute to your mailing list address. The mailMessageStore attribute should point to the directory that your mailing list is pointing to. Also, qmailDotMode should be set to either dotonly or both and you will probably want to make sure that the accountStatus is flagged as nopop.</P>
<P>For example:</P>
<PRE>
  dn: uid=all.marketingtips.com, ou=lists, o=imc
  objectClass: top
  objectClass: qmailUser
  uid: all.marketingtips.com
  cn: all@marketingtips.com
  ou: lists
  mail: all@marketingtips.com
  mailAlternateAddress: all-catchall@marketingtips.com
  mailMessageStore: imc/lists/all.marketingtips.com
  accountStatus: nopop
  qmailDotMode: dotonly
</PRE>
<HR>
<H1><A NAME="useful Links">E. useful Links</A></H1>
<HR>
<H1><A NAME="Acknowlegements">F. Acknowlegements</A></H1>
<P>Dave Sill for support and encouragement, and for letting me call this Life With qmail-ldap in frank homage to his Life With qmail.</P>
<P>Bennet Todd &lt;bet@rahul.net&gt; for &quot;Life with djbdns&quot;, which was more than a big inspiration.</P>
<P>Turbo Fredriksson &lt;turbo@bayour.com&gt; for his qmail-ldap-control patch and writing the part about that, and for long discussions about programming style and additional patches to qmail-ldap.</P>
<P>Gary Richardson &lt;gary.richardson@marketingtips.com&gt; for the ezmlm-stuff.</P>
<P>Mike Jackson &lt;copperhead@snakebite.com&gt; for the Solaris specifics, the LDAP Intro and various other stuff.</P>
<P>Arek Dreyer &lt;arek@arekdreyer.com&gt; for his extended smtp after pop scripts and various corrections.</P>
<P>Claudio Jeker &lt;jeker@n-r-g.com&gt; for the notes about shared libraries.</P>
<P>Adam McKenna &lt;adam@flounder.net&gt; for the Netscape LDAP SDK notes.</P>
<P>Jorge Rocha Gualtieri &lt;jorge@jrg.com.br&gt; for the qmail-ldap big picture.</P>
<P>$Id: lwql.sdf,v 1.24 2003/03/25 16:47:58 brahe Exp $</P>
</DIV>
<DIV CLASS="footer">
<DIV CLASS="navigate">
</DIV>
</DIV>

</BODY>
</HTML>
